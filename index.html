<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://the-mysterious-stranger.vercel.app http://localhost:3000;">
    <title>The Mysterious Stranger - Adventure</title>
    <style>
        body {
            background: #222;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
        }
        .game-frame {
            background: #111;
            border: 6px solid #bfa76a;
            border-radius: 12px;
            box-shadow: 0 0 32px #000a;
            width: 700px;
            max-width: 98vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 0 24px 0;
        }
        .artwork-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            border-bottom: 4px solid #bfa76a;
            border-radius: 6px 6px 0 0;
            min-height: 220px;
            overflow: hidden;
            position: relative;
            box-sizing: border-box;
        }
        .artwork {
            max-width: 100%;
            max-height: 420px;
            width: auto;
            height: auto;
            object-fit: contain;
            background: #111;
            display: block;
            margin: 0 auto;
        }
        .textbox {
            width: 92%;
            margin: 0 auto;
            margin-top: 18px;
            background: #f8f8e8;
            border: 3px solid #444;
            border-radius: 8px;
            box-shadow: 0 2px 8px #0003;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.18em;
            color: #222;
            padding: 18px 18px 10px 18px;
            min-height: 90px;
            position: relative;
        }
        .choices-container {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            align-items: center;
        }
        .choice-btn {
            background: #bfa76a;
            color: #222;
            border: 2px solid #444;
            padding: 10px 28px;
            border-radius: 6px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.08em;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            box-shadow: 0 2px 8px #0002;
        }
        .choice-btn:hover {
            background: #e6d8a8;
            color: #111;
        }
        .choice-btn:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
        }
        .restart-btn {
            background: #444;
            color: #f8f8e8;
            border: 2px solid #bfa76a;
            padding: 8px 18px;
            border-radius: 6px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1em;
            cursor: pointer;
            margin-top: 18px;
            transition: background 0.2s, color 0.2s;
        }
        .restart-btn:hover {
            background: #bfa76a;
            color: #222;
        }
        .scene {
            display: none;
        }
        .scene.active {
            display: block;
        }
        .loading {
            color: #bfa76a;
            font-style: italic;
        }
        .error {
            color: #ff6b6b;
            margin: 10px 0;
        }
        .success {
            color: #51cf66;
            margin: 10px 0;
        }
        .wallet-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        .wallet-connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .wallet-disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        @media (max-width: 800px) {
            .game-frame { 
                width: 99vw; 
                max-width: 99vw;
                margin: 0 auto;
            }
            .artwork { 
                max-height: 220px;
                max-width: 95%;
            }
        }
        @media (max-width: 768px) {
            .artwork {
                max-width: 90%;
                max-height: 200px;
            }
            .artwork-container {
                min-height: 180px;
                padding: 5px;
            }
            .game-frame {
                width: 100vw;
                max-width: 100vw;
                border-radius: 0;
                border-left: none;
                border-right: none;
            }
        }
        @media (max-width: 480px) {
            .artwork {
                max-width: 85%;
                max-height: 180px;
            }
            .artwork-container {
                min-height: 160px;
                padding: 3px;
            }
        }
    </style>
</head>
<body>
    <div class="game-frame">
        <!-- Wallet Connection Scene -->
        <div id="verification" class="scene active">
            <div class="artwork-container">
                <img src="MAIN.jpg" alt="The Mysterious Stranger" class="artwork">
            </div>
            <div class="textbox" style="text-align:center;">
                <h2 style="margin-top:0;">The Mysterious Stranger</h2>
                <p>Connect your Solana wallet and prove ownership of the required NFT to access this exclusive adventure.</p>
                
                <div id="walletStatus" class="wallet-status wallet-disconnected">
                    No wallet connected
                </div>
                
                <div id="verificationMessage"></div>
                
                <div class="choices-container" style="margin-top:24px;">
                    <button class="choice-btn" onclick="connectWallet()" id="connectBtn">Connect Wallet</button>
                </div>
            </div>
        </div>

        <!-- Main Page -->
        <div id="scene0" class="scene">
            <div class="artwork-container">
                <img src="MAIN.jpg" alt="The Mysterious Stranger" class="artwork">
            </div>
            <div class="textbox" style="text-align:center; font-size:1.5em;">
                The Mysterious Stranger
                <div class="choices-container" style="margin-top:24px;">
                    <button class="choice-btn" onclick="showScene(1)">Begin</button>
                </div>
            </div>
        </div>
        
        <!-- Scene 1 -->
        <div id="scene1" class="scene">
            <div class="artwork-container">
                <img src="SPEARMAN.jpg" alt="A man with a spear in the distance" class="artwork">
            </div>
            <div class="textbox">
                The sun is low as you walk the lonely road. In the distance you see a man standing still gripping a long spear. Something about his posture and the way the light glints off his weapon makes you pause. You feel a strange pull perhaps he knows something about the path ahead or maybe you just crave a break from solitude.
                <div class="choices-container">
                    <button class="choice-btn" onclick="showScene(2)">Approach the man</button>
                    <button class="choice-btn" onclick="showScene(0)">Avoid him (but curiosity gnaws at you)</button>
                </div>
            </div>
        </div>
        
        <!-- Scene 2 -->
        <div id="scene2" class="scene">
            <div class="artwork-container">
                <img src="ZOOMMAN.jpg" alt="Zoomed in on the man" class="artwork">
            </div>
            <div class="textbox">
                As you draw closer the man's features come into focus. He looks tired but determined. He raises his spear in greeting then asks "Traveler do you have a moment I need help with a task. If you assist me I promise a reward."
                <div class="choices-container">
                    <button class="choice-btn" onclick="showScene(3)">Accept his request</button>
                    <button class="choice-btn" onclick="showScene(0)">Say no (but something about his earnestness makes you reconsider)</button>
                </div>
            </div>
        </div>
        
        <!-- Scene 3 -->
        <div id="scene3" class="scene">
            <div class="artwork-container">
                <img src="REWARDKEY.jpg" alt="The man holding a key and a reward" class="artwork">
            </div>
            <div class="textbox">
                The man smiles and reveals a small ornate key. "This key is needed to open the door on the mountain side to get my lost item. I cannot retrieve it alone. If you help me this key and a reward will be yours."
                <div class="choices-container">
                    <button class="choice-btn" onclick="showScene(4)">Agree to help and head to the cave</button>
                </div>
            </div>
        </div>
        
        <!-- Scene 4 -->
        <div id="scene4" class="scene">
            <div class="artwork-container">
                <img src="CAVE.jpg" alt="Approaching the cave door" class="artwork">
            </div>
            <div class="textbox">
                <span id="scene4-text">
                You arrive at the mouth of the cave. The heavy wooden door is slightly ajar darkness yawning beyond. The air is thick with anticipation.
                </span>
                <div class="choices-container" id="scene4-choices">
                    <button class="choice-btn" onclick="enterCave()">Go in</button>
                    <button class="choice-btn" onclick="lookAround()">Look around to see if the coast is clear</button>
                </div>
                <div class="choices-container" id="scene4-extra" style="display:none;"></div>
            </div>
        </div>
        
        <!-- Scene 5 -->
        <div id="scene5" class="scene">
            <div class="artwork-container">
                <img src="GOBLIN.jpg" alt="Attacked by goblins" class="artwork">
            </div>
            <div class="textbox">
                As you step inside a shriek pierces the darkness. Goblins leap from the shadows brandishing crude weapons. There is no time to think only to fight.
                <div class="choices-container">
                    <button class="choice-btn" onclick="showScene(6)">FIGHT</button>
                </div>
            </div>
        </div>
        
        <!-- Scene 6 - Victory Over Goblins -->
        <div id="scene6" class="scene">
            <div class="artwork-container">
                <img src="GOBLIN.jpg" alt="Victory over goblins" class="artwork">
            </div>
            <div class="textbox">
                With a swift and decisive strike, you deliver a fatal blow to one of the goblins. The other, seeing its companion fall, turns and flees into the darkness. You have successfully survived the encounter and proven your combat prowess.
                <div class="choices-container">
                    <button class="choice-btn" onclick="showScene(7)">Explore the cave further</button>
                </div>
            </div>
        </div>
        
        <!-- Scene 7 - Treasure Chest -->
        <div id="scene7" class="scene">
            <div class="artwork-container">
                <img src="GOBLINATTACK.jpg" alt="Treasure chest of gold" class="artwork">
            </div>
            <div class="textbox">
                Venturing deeper into the cave, you discover a hidden chamber. In the flickering light, you spot a magnificent chest overflowing with gold coins and precious gems. The stranger's lost item was indeed valuable - this treasure could change your fortune forever.
                <div class="choices-container">
                    <button class="choice-btn" onclick="restartStory()">Claim the treasure and return to the stranger</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API base URL - will work both locally and when deployed
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:3000' 
            : 'https://the-mysterious-stranger.vercel.app';
            
        // Security: Input validation
        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            return input.trim().replace(/[<>]/g, '');
        }
        
        // Security: Validate wallet address format
        function isValidWalletAddress(address) {
            if (!address || typeof address !== 'string') return false;
            return /^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(address.trim());
        }
        
        // Security: Proper session encryption using Web Crypto API
        let sessionEncryptionKey = null;
        
        async function initializeEncryption() {
            try {
                // Generate or retrieve encryption key
                const keyData = sessionStorage.getItem('session_key');
                if (keyData) {
                    const keyBuffer = Uint8Array.from(JSON.parse(keyData));
                    sessionEncryptionKey = await crypto.subtle.importKey(
                        'raw', keyBuffer, 'AES-GCM', false, ['encrypt', 'decrypt']
                    );
                } else {
                    // Generate new key
                    sessionEncryptionKey = await crypto.subtle.generateKey(
                        { name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']
                    );
                    const exported = await crypto.subtle.exportKey('raw', sessionEncryptionKey);
                    sessionStorage.setItem('session_key', JSON.stringify(Array.from(exported)));
                }
            } catch (error) {
                console.error('Failed to initialize encryption:', error);
                // Fallback to base64 (less secure but functional)
                sessionEncryptionKey = null;
            }
        }
        
        async function secureStore(key, value) {
            try {
                if (sessionEncryptionKey) {
                    // Use proper encryption
                    const iv = crypto.getRandomValues(new Uint8Array(12));
                    const encoded = new TextEncoder().encode(JSON.stringify(value));
                    const encrypted = await crypto.subtle.encrypt(
                        { name: 'AES-GCM', iv }, sessionEncryptionKey, encoded
                    );
                    const combined = new Uint8Array(iv.length + encrypted.byteLength);
                    combined.set(iv);
                    combined.set(new Uint8Array(encrypted), iv.length);
                    sessionStorage.setItem(key, btoa(String.fromCharCode(...combined)));
                } else {
                    // Fallback to base64 encoding
                    const encoded = btoa(JSON.stringify(value));
                    sessionStorage.setItem(key, encoded);
                }
            } catch (error) {
                console.error('Failed to store session:', error);
            }
        }
        
        async function secureRetrieve(key) {
            try {
                const stored = sessionStorage.getItem(key);
                if (!stored) return null;
                
                if (sessionEncryptionKey) {
                    // Decrypt properly encrypted data
                    const combined = new Uint8Array(atob(stored).split('').map(c => c.charCodeAt(0)));
                    const iv = combined.slice(0, 12);
                    const encrypted = combined.slice(12);
                    const decrypted = await crypto.subtle.decrypt(
                        { name: 'AES-GCM', iv }, sessionEncryptionKey, encrypted
                    );
                    return JSON.parse(new TextDecoder().decode(decrypted));
                } else {
                    // Fallback to base64 decoding
                    return JSON.parse(atob(stored));
                }
            } catch (error) {
                console.error('Failed to retrieve session:', error);
                return null;
            }
        }
        
        // Simple base58 encoding function
        function base58Encode(bytes) {
            const alphabet = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
            let num = 0n;
            for (let i = 0; i < bytes.length; i++) {
                num = num * 256n + BigInt(bytes[i]);
            }
            let str = '';
            while (num > 0n) {
                str = alphabet[Number(num % 58n)] + str;
                num = num / 58n;
            }
            // Handle leading zeros
            for (let i = 0; i < bytes.length && bytes[i] === 0; i++) {
                str = '1' + str;
            }
            return str;
        }
            
        // Security: Request timestamp for anti-replay protection
        function addTimestamp(body) {
            return {
                timestamp: Date.now().toString()
            };
        }
        
        // Security: Make timestamped API request
        async function makeTimestampedRequest(url, body) {
            const timestamp = Date.now().toString();
            
            return fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Request-Timestamp': timestamp
                },
                body: JSON.stringify(body)
            });
        }
        
        let isVerified = false;
        let sessionToken = null;
        let walletProvider = null;
        let connectedWallet = null;

        // Check if user has a valid session on page load
        async function checkExistingSession() {
            const sessionData = await secureRetrieve('nft_session_token');
            if (!sessionData || !sessionData.token) return false;
            
            const token = sessionData.token;

            try {
                const response = await fetch(`${API_BASE_URL}/api/verify-nft`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.valid) {
                        isVerified = true;
                        sessionToken = token;
                        connectedWallet = data.walletAddress;
                        updateWalletStatus(`Connected: ${data.walletAddress.substring(0, 8)}...`, true);
                        showScene(0);
                        return true;
                    }
                }
            } catch (error) {
                console.error('Session check failed:', error);
            }

            localStorage.removeItem('nft_session_token');
            return false;
        }

        // Update wallet connection status display
        function updateWalletStatus(message, connected = false) {
            const statusDiv = document.getElementById('walletStatus');
            statusDiv.textContent = message;
            statusDiv.className = `wallet-status ${connected ? 'wallet-connected' : 'wallet-disconnected'}`;
        }

        // Enhanced wallet detection function
        function detectWallet() {
            console.log('Detecting wallets...');
            console.log('Available window objects:', Object.keys(window).filter(k => 
                k.toLowerCase().includes('solana') || 
                k.toLowerCase().includes('phantom') || 
                k.toLowerCase().includes('solflare') || 
                k.toLowerCase().includes('backpack')
            ));
            
            // Check for Solflare first (most specific)
            if (window.solflare && typeof window.solflare.connect === 'function') {
                console.log('Solflare wallet detected via window.solflare');
                console.log('Solflare methods:', Object.getOwnPropertyNames(window.solflare));
                return { provider: window.solflare, type: 'Solflare' };
            }
            
            // Check for Backpack
            if (window.backpack && typeof window.backpack.connect === 'function') {
                console.log('Backpack wallet detected via window.backpack');
                console.log('Backpack methods:', Object.getOwnPropertyNames(window.backpack));
                return { provider: window.backpack, type: 'Backpack' };
            }
            
            // Check window.solana for different wallet types
            if (window.solana) {
                console.log('window.solana found');
                console.log('window.solana properties:', {
                    isPhantom: window.solana.isPhantom,
                    isSolflare: window.solana.isSolflare,
                    isBackpack: window.solana.isBackpack,
                    isSlope: window.solana.isSlope,
                    isGlow: window.solana.isGlow
                });
                console.log('window.solana methods:', Object.getOwnPropertyNames(window.solana));
                
                if (window.solana.isPhantom) {
                    console.log('Phantom wallet detected');
                    return { provider: window.solana, type: 'Phantom' };
                }
                
                if (window.solana.isSolflare) {
                    console.log('Solflare wallet detected via window.solana.isSolflare');
                    return { provider: window.solana, type: 'Solflare' };
                }
                
                if (window.solana.isBackpack) {
                    console.log('Backpack wallet detected via window.solana.isBackpack');
                    return { provider: window.solana, type: 'Backpack' };
                }
                
                if (window.solana.isSlope) {
                    console.log('Slope wallet detected');
                    return { provider: window.solana, type: 'Slope' };
                }
                
                if (window.solana.isGlow) {
                    console.log('Glow wallet detected');
                    return { provider: window.solana, type: 'Glow' };
                }
                
                // Generic Solana wallet
                if (typeof window.solana.connect === 'function') {
                    console.log('Generic Solana wallet detected');
                    return { provider: window.solana, type: 'Solana' };
                }
            }
            
            console.log('No wallet detected');
            return null;
        }

        // Enhanced signing function for different wallets
        async function signMessageWithWallet(walletInfo, message) {
            const { provider, type } = walletInfo;
            const encodedMessage = new TextEncoder().encode(message);
            
            console.log(`[${type}] Attempting to sign message...`);
            console.log(`[${type}] Message to sign:`, message);
            console.log(`[${type}] Encoded message:`, encodedMessage);
            console.log(`[${type}] Available methods:`, Object.getOwnPropertyNames(provider));
            
            try {
                let signResult;
                
                if (type === 'Solflare') {
                    console.log(`[${type}] Using Solflare-specific signing...`);
                    
                    // Solflare has very specific requirements
                    if (typeof provider.signMessage === 'function') {
                        try {
                            console.log(`[${type}] Trying signMessage with Uint8Array...`);
                            signResult = await provider.signMessage(encodedMessage);
                            console.log(`[${type}] signMessage result:`, signResult);
                        } catch (error1) {
                            console.log(`[${type}] First attempt failed:`, error1.message);
                            try {
                                console.log(`[${type}] Trying signMessage with string...`);
                                signResult = await provider.signMessage(message);
                                console.log(`[${type}] signMessage with string result:`, signResult);
                            } catch (error2) {
                                console.log(`[${type}] Second attempt failed:`, error2.message);
                                throw new Error(`Solflare signMessage failed: ${error2.message}`);
                            }
                        }
                    } else {
                        throw new Error('Solflare wallet does not have signMessage method');
                    }
                } else if (type === 'Backpack') {
                    console.log(`[${type}] Using Backpack-specific signing...`);
                    
                    if (typeof provider.signMessage === 'function') {
                        try {
                            console.log(`[${type}] Trying signMessage with Uint8Array...`);
                            signResult = await provider.signMessage(encodedMessage);
                            console.log(`[${type}] signMessage result:`, signResult);
                        } catch (error1) {
                            console.log(`[${type}] First attempt failed:`, error1.message);
                            try {
                                console.log(`[${type}] Trying signMessage with string...`);
                                signResult = await provider.signMessage(message);
                                console.log(`[${type}] signMessage with string result:`, signResult);
                            } catch (error2) {
                                console.log(`[${type}] Second attempt failed:`, error2.message);
                                throw new Error(`Backpack signMessage failed: ${error2.message}`);
                            }
                        }
                    } else {
                        throw new Error('Backpack wallet does not have signMessage method');
                    }
                } else {
                    // Phantom and other wallets
                    console.log(`[${type}] Using standard signing...`);
                    
                    if (typeof provider.signMessage === 'function') {
                        try {
                            console.log(`[${type}] Trying signMessage with standard parameters...`);
                            signResult = await provider.signMessage(encodedMessage, 'utf8');
                            console.log(`[${type}] signMessage result:`, signResult);
                        } catch (error1) {
                            console.log(`[${type}] UTF8 method failed:`, error1.message);
                            try {
                                console.log(`[${type}] Trying signMessage without encoding...`);
                                signResult = await provider.signMessage(encodedMessage);
                                console.log(`[${type}] signMessage without encoding result:`, signResult);
                            } catch (error2) {
                                console.log(`[${type}] Standard method failed:`, error2.message);
                                throw new Error(`${type} signMessage failed: ${error2.message}`);
                            }
                        }
                    } else {
                        throw new Error(`${type} wallet does not have signMessage method`);
                    }
                }
                
                console.log(`[${type}] Full signing result:`, signResult);
                console.log(`[${type}] Result type:`, typeof signResult);
                console.log(`[${type}] Result keys:`, signResult ? Object.keys(signResult) : 'null');
                
                // Extract signature from result
                let signature;
                if (signResult && signResult.signature) {
                    signature = signResult.signature;
                    console.log(`[${type}] Found signature in result.signature:`, signature);
                } else if (signResult && signResult.data) {
                    signature = signResult.data;
                    console.log(`[${type}] Found signature in result.data:`, signature);
                } else if (signResult && typeof signResult === 'object' && signResult.constructor === Uint8Array) {
                    signature = signResult;
                    console.log(`[${type}] Result is directly a Uint8Array:`, signature);
                } else if (typeof signResult === 'string') {
                    signature = signResult;
                    console.log(`[${type}] Result is directly a string:`, signature);
                } else {
                    console.error(`[${type}] Unexpected signature format:`, signResult);
                    throw new Error(`Unexpected signature format from ${type}`);
                }
                
                // Convert signature to base58 string if needed
                let finalSignature;
                if (signature instanceof Uint8Array) {
                    finalSignature = base58Encode(signature);
                    console.log(`[${type}] Converted Uint8Array to base58:`, finalSignature);
                } else if (typeof signature === 'string') {
                    finalSignature = signature;
                    console.log(`[${type}] Using string signature directly:`, finalSignature);
                } else {
                    console.error(`[${type}] Cannot process signature type:`, typeof signature, signature);
                    throw new Error(`Cannot process signature from ${type}`);
                }
                
                console.log(`[${type}] Final signature:`, finalSignature);
                return finalSignature;
                
            } catch (error) {
                console.error(`[${type}] Signing failed:`, error);
                throw new Error(`Failed to sign message with ${type}: ${error.message}`);
            }
        }

        // Connect to Solana wallet
        async function connectWallet() {
            const connectBtn = document.getElementById('connectBtn');
            const messageDiv = document.getElementById('verificationMessage');
            
            connectBtn.disabled = true;
            connectBtn.textContent = 'Connecting...';
            messageDiv.innerHTML = '<div class="loading">Looking for wallet...</div>';

            try {
                // Detect wallet
                const walletInfo = detectWallet();
                
                if (!walletInfo) {
                    console.log('No wallet provider found.');
                    messageDiv.innerHTML = '<div class="error">No Solana wallet detected. Please install a supported wallet like <a href="https://phantom.app/" target="_blank">Phantom</a>, <a href="https://solflare.com/" target="_blank">Solflare</a>, or <a href="https://backpack.app/" target="_blank">Backpack</a>.</div>';
                    connectBtn.disabled = false;
                    connectBtn.textContent = 'Connect Wallet';
                    return;
                }

                const { provider, type } = walletInfo;
                console.log(`Found ${type} wallet`);

                // Connect to wallet
                messageDiv.innerHTML = `<div class="loading">Connecting to ${type}...</div>`;
                
                let response;
                try {
                    response = await provider.connect();
                    console.log(`[${type}] Connection response:`, response);
                } catch (connectError) {
                    console.error(`[${type}] Connection failed:`, connectError);
                    throw new Error(`Failed to connect to ${type}. Please try again.`);
                }
                
                // Extract wallet address from response
                let rawWalletAddress;
                console.log(`[${type}] Full connection response:`, response);
                console.log(`[${type}] Response type:`, typeof response);
                console.log(`[${type}] Response constructor:`, response ? response.constructor.name : 'null');
                console.log(`[${type}] Response keys:`, response ? Object.keys(response) : 'null');
                
                if (response && response.publicKey) {
                    console.log(`[${type}] Found publicKey:`, response.publicKey);
                    if (typeof response.publicKey.toString === 'function') {
                        rawWalletAddress = response.publicKey.toString();
                    } else {
                        rawWalletAddress = response.publicKey;
                    }
                } else if (response && response.pubkey) {
                    console.log(`[${type}] Found pubkey:`, response.pubkey);
                    rawWalletAddress = response.pubkey.toString();
                } else if (response && response.address) {
                    console.log(`[${type}] Found address:`, response.address);
                    rawWalletAddress = response.address;
                } else if (response && response.account) {
                    console.log(`[${type}] Found account:`, response.account);
                    rawWalletAddress = response.account;
                } else if (response && response.accounts && response.accounts[0]) {
                    console.log(`[${type}] Found accounts[0]:`, response.accounts[0]);
                    rawWalletAddress = response.accounts[0];
                } else if (typeof response === 'string') {
                    console.log(`[${type}] Response is string:`, response);
                    rawWalletAddress = response;
                } else if (response && typeof response === 'object') {
                    // Debug: log all properties to find the address
                    console.log(`[${type}] Searching for address in response properties:`);
                    for (const [key, value] of Object.entries(response)) {
                        console.log(`[${type}] ${key}:`, value, typeof value);
                        if (typeof value === 'string' && value.length > 30 && /^[1-9A-HJ-NP-Za-km-z]+$/.test(value)) {
                            console.log(`[${type}] Found potential address in ${key}:`, value);
                            rawWalletAddress = value;
                            break;
                        } else if (value && typeof value === 'object' && typeof value.toString === 'function') {
                            try {
                                const stringValue = value.toString();
                                if (stringValue.length > 30 && /^[1-9A-HJ-NP-Za-km-z]+$/.test(stringValue)) {
                                    console.log(`[${type}] Found potential address by toString() in ${key}:`, stringValue);
                                    rawWalletAddress = stringValue;
                                    break;
                                }
                            } catch (e) {
                                console.log(`[${type}] Could not toString() ${key}:`, e.message);
                            }
                        }
                    }
                    
                    if (!rawWalletAddress) {
                        console.error(`[${type}] Could not find wallet address in response:`, response);
                        throw new Error(`Could not extract wallet address from ${type} response`);
                    }
                } else {
                    console.error(`[${type}] Unexpected wallet response format:`, response);
                    throw new Error(`Unexpected response format from ${type}`);
                }
                
                console.log(`[${type}] Raw wallet address:`, rawWalletAddress);
                
                // Validate wallet address
                if (!isValidWalletAddress(rawWalletAddress)) {
                    throw new Error('Invalid wallet address received from provider');
                }
                
                connectedWallet = sanitizeInput(rawWalletAddress);
                
                updateWalletStatus(`Connected: ${connectedWallet.substring(0, 8)}... (${type})`, true);
                messageDiv.innerHTML = '<div class="loading">Wallet connected. Generating challenge...</div>';

                // Step 1: Get challenge from server
                const challengeResponse = await makeTimestampedRequest(`${API_BASE_URL}/api/verify-nft`, {
                    action: 'challenge',
                    walletAddress: connectedWallet
                });

                const challengeData = await challengeResponse.json();
                if (!challengeData.success) {
                    throw new Error(challengeData.error);
                }

                messageDiv.innerHTML = '<div class="loading">Please sign the message in your wallet to verify ownership...</div>';

                // Step 2: Sign the challenge message
                const signature = await signMessageWithWallet(walletInfo, challengeData.message);

                messageDiv.innerHTML = '<div class="loading">Verifying signature and checking NFT ownership...</div>';

                // Step 3: Verify signature and check NFT
                const verifyResponse = await makeTimestampedRequest(`${API_BASE_URL}/api/verify-nft`, {
                    action: 'verify',
                    walletAddress: connectedWallet,
                    signature: signature,
                    challenge: challengeData.challenge
                });

                const verifyData = await verifyResponse.json();

                if (verifyData.success) {
                    isVerified = true;
                    sessionToken = verifyData.sessionToken;
                    
                    // Store session securely
                    await secureStore('nft_session_token', {
                        token: sessionToken,
                        wallet: connectedWallet.substring(0, 8) + '...',
                        walletType: type,
                        timestamp: Date.now()
                    });
                    
                    messageDiv.innerHTML = '<div class="success">Wallet verified and NFT ownership confirmed! Welcome, adventurer.</div>';
                    
                    setTimeout(() => {
                        showScene(0);
                    }, 2000);
                } else {
                    messageDiv.innerHTML = `<div class="error">Verification failed: ${verifyData.error}</div>`;
                    updateWalletStatus('Wallet connected but verification failed', false);
                    connectBtn.disabled = false;
                    connectBtn.textContent = 'Try Again';
                }

            } catch (error) {
                console.error('Wallet connection error:', error);
                if (error.message.includes('User rejected') || error.message.includes('cancelled')) {
                    messageDiv.innerHTML = '<div class="error">Wallet connection cancelled by user.</div>';
                } else {
                    messageDiv.innerHTML = `<div class="error">Connection failed: ${error.message}</div>`;
                }
                updateWalletStatus('Connection failed', false);
                connectBtn.disabled = false;
                connectBtn.textContent = 'Connect Wallet';
            }
        }

        // Verify session before accessing any scene
        async function verifySession() {
            const sessionData = await secureRetrieve('nft_session_token');
            if (!sessionData || !sessionData.token) return false;
            
            const token = sessionData.token;

            try {
                const response = await fetch(`${API_BASE_URL}/api/verify-nft`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.valid;
                }
            } catch (error) {
                console.error('Session verification failed:', error);
            }

            return false;
        }

        async function showScene(num) {
            // Always verify session before showing scenes (except verification page)
            if (num !== 'verification') {
                const sessionValid = await verifySession();
                if (!sessionValid) {
                    isVerified = false;
                    sessionToken = null;
                    connectedWallet = null;
                    sessionStorage.removeItem('nft_session_token');
                    updateWalletStatus('Session expired', false);
                    document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
                    document.getElementById('verification').classList.add('active');
                    return;
                }
            }

            document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
            
            if (num === 'verification') {
                document.getElementById('verification').classList.add('active');
            } else {
                document.getElementById('scene'+num).classList.add('active');
            }
            
            // Reset scene 4 state every time you enter it
            if (num === 4) {
                document.getElementById('scene4-text').innerText =
                    "You arrive at the mouth of the cave. The heavy wooden door is slightly ajar darkness yawning beyond. The air is thick with anticipation.";
                document.getElementById('scene4-choices').style.display = '';
                document.getElementById('scene4-extra').style.display = 'none';
                document.getElementById('scene4-extra').innerHTML = '';
            }
        }

        function restartStory() {
            showScene(0);
        }

        // Scene 4 logic
        function enterCave() {
            showScene(5);
        }

        function lookAround() {
            const extra = document.getElementById('scene4-extra');
            extra.innerHTML = '';
            if (Math.floor(Math.random()*6) === 0) {
                document.getElementById('scene4-text').innerText =
                    "You listen closely. Suddenly you hear shuffling and guttural whispers on the other side of the door. Before you can react the door bursts open.";
                document.getElementById('scene4-choices').style.display = 'none';
                extra.style.display = '';
                extra.innerHTML = `<button class='choice-btn' onclick='showScene(5)'>Sneak in and attack</button> <button class='choice-btn' onclick='showScene(0)'>This is too scary runaway</button>`;
            } else {
                document.getElementById('scene4-text').innerText =
                    "You look around carefully. All seems quiet. Gathering your courage you decide to unlock the door and go in.";
                document.getElementById('scene4-choices').style.display = 'none';
                extra.style.display = '';
                extra.innerHTML = `<button class='choice-btn' onclick='showScene(5)'>Unlock the door and go in</button>`;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeEncryption();
            checkExistingSession();
        });
    </script>
</body>
</html>
