<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://the-mysterious-stranger.vercel.app http://localhost:3000;">
    <title>The Mysterious Stranger - Adventure</title>
    <style>
        body {
            background: #222;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
        }
        .game-frame {
            background: #111;
            border: 6px solid #bfa76a;
            border-radius: 12px;
            box-shadow: 0 0 32px #000a;
            width: 700px;
            max-width: 98vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 0 24px 0;
        }
        .artwork-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            border-bottom: 4px solid #bfa76a;
            border-radius: 6px 6px 0 0;
            min-height: 220px;
            overflow: hidden;
            position: relative;
            box-sizing: border-box;
        }
        .artwork {
            max-width: 100%;
            max-height: 420px;
            width: auto;
            height: auto;
            object-fit: contain;
            background: #111;
            display: block;
            margin: 0 auto;
        }
        .textbox {
            width: 92%;
            margin: 0 auto;
            margin-top: 18px;
            background: #f8f8e8;
            border: 3px solid #444;
            border-radius: 8px;
            box-shadow: 0 2px 8px #0003;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.18em;
            color: #222;
            padding: 18px 18px 10px 18px;
            min-height: 90px;
            position: relative;
        }
        .choices-container {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            align-items: center;
        }
        .choice-btn {
            background: #bfa76a;
            color: #222;
            border: 2px solid #444;
            padding: 10px 28px;
            border-radius: 6px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.08em;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            box-shadow: 0 2px 8px #0002;
        }
        .choice-btn:hover {
            background: #e6d8a8;
            color: #111;
        }
        .choice-btn:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
        }
        .restart-btn {
            background: #444;
            color: #f8f8e8;
            border: 2px solid #bfa76a;
            padding: 8px 18px;
            border-radius: 6px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1em;
            cursor: pointer;
            margin-top: 18px;
            transition: background 0.2s, color 0.2s;
        }
        .restart-btn:hover {
            background: #bfa76a;
            color: #222;
        }
        .scene {
            display: none;
        }
        .scene.active {
            display: block;
        }
        .loading {
            color: #bfa76a;
            font-style: italic;
        }
        .error {
            color: #ff6b6b;
            margin: 10px 0;
        }
        .success {
            color: #51cf66;
            margin: 10px 0;
        }
        .wallet-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        .wallet-connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .wallet-disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .inventory-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #444;
            color: #bfa76a;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            border: 1px solid #bfa76a;
        }
        @media (max-width: 800px) {
            .game-frame { 
                width: 99vw; 
                max-width: 99vw;
                margin: 0 auto;
            }
            .artwork { 
                max-height: 220px;
                max-width: 95%;
            }
        }
        @media (max-width: 768px) {
            .artwork {
                max-width: 90%;
                max-height: 200px;
            }
            .artwork-container {
                min-height: 180px;
                padding: 5px;
            }
            .game-frame {
                width: 100vw;
                max-width: 100vw;
                border-radius: 0;
                border-left: none;
                border-right: none;
            }
        }
        @media (max-width: 480px) {
            .artwork {
                max-width: 85%;
                max-height: 180px;
            }
            .artwork-container {
                min-height: 160px;
                padding: 3px;
            }
        }
    </style>
</head>
<body>
    <div class="game-frame">
        <!-- Wallet Connection Scene -->
        <div id="verification" class="scene active">
            <div class="artwork-container">
                <img src="MAIN.jpg" alt="The Mysterious Stranger" class="artwork">
            </div>
            <div class="textbox" style="text-align:center;">
                <h2 style="margin-top:0;">The Mysterious Stranger</h2>
                <p>Connect your Solana wallet and prove ownership of the required NFT to access this exclusive adventure.</p>
                
                <div id="walletStatus" class="wallet-status wallet-disconnected">
                    No wallet connected
                </div>
                
                <div id="verificationMessage"></div>
                
                <div class="choices-container" style="margin-top:24px;">
                    <button class="choice-btn" onclick="connectWallet()" id="connectBtn">Connect Wallet</button>
                </div>
            </div>
        </div>

        <!-- Main Page -->
        <div id="scene0" class="scene">
            <div class="artwork-container">
                <img src="MAIN.jpg" alt="The Mysterious Stranger" class="artwork">
            </div>
            <div class="textbox" style="text-align:center; font-size:1.5em;">
                The Mysterious Stranger
                <div class="choices-container" style="margin-top:24px;">
                    <button class="choice-btn" onclick="showScene(1)">Begin</button>
                </div>
            </div>
        </div>
        
        <!-- Scene 1 -->
        <div id="scene1" class="scene">
            <div class="artwork-container">
                <img src="SPEARMAN.jpg" alt="A man with a spear in the distance" class="artwork">
            </div>
            <div class="textbox">
                <div class="inventory-status" id="inventory1"></div>
                The sun is low as you walk the lonely road. In the distance you see a man standing still gripping a long spear. Something about his posture and the way the light glints off his weapon makes you pause. You feel a strange pull perhaps he knows something about the path ahead or maybe you just crave a break from solitude.
                <div class="choices-container">
                    <button class="choice-btn" onclick="showScene(2)">Approach the man</button>
                    <button class="choice-btn" onclick="showScene(8)">Avoid him and continue down the path</button>
                </div>
            </div>
        </div>
        
        <!-- Scene 2 -->
        <div id="scene2" class="scene">
            <div class="artwork-container">
                <img src="ZOOMMAN.jpg" alt="Zoomed in on the man" class="artwork">
            </div>
            <div class="textbox">
                <div class="inventory-status" id="inventory2"></div>
                As you draw closer the man's features come into focus. He looks tired but determined. He raises his spear in greeting then asks "Traveler do you have a moment I need help with a task. If you assist me I promise a reward."
                <div class="choices-container">
                    <button class="choice-btn" onclick="showScene(3)">Accept his request</button>
                    <button class="choice-btn" onclick="showScene(8)">Say no and continue down the path</button>
                </div>
            </div>
        </div>
        
        <!-- Scene 3 -->
        <div id="scene3" class="scene">
            <div class="artwork-container">
                <img src="REWARDKEY.jpg" alt="The man holding a key and a reward" class="artwork">
            </div>
            <div class="textbox">
                <div class="inventory-status" id="inventory3"></div>
                The man smiles and reveals a small ornate key. "This key is needed to open the door on the mountain side to get my lost item. I cannot retrieve it alone. If you help me this key and a reward will be yours."
                <div class="choices-container">
                    <button class="choice-btn" onclick="acceptQuest()">Agree to help and head to the cave</button>
                </div>
            </div>
        </div>
        
        <!-- Scene 4 - With Key -->
        <div id="scene4" class="scene">
            <div class="artwork-container">
                <img src="CAVE.jpg" alt="Approaching the cave door" class="artwork">
            </div>
            <div class="textbox">
                <div class="inventory-status" id="inventory4"></div>
                <span id="scene4-text">
                You arrive at the mouth of the cave. The heavy wooden door stands before you, and you remember the ornate key the stranger gave you. The air is thick with anticipation.
                </span>
                <div class="choices-container" id="scene4-choices">
                    <button class="choice-btn" onclick="enterCave()">Use the key and go in</button>
                    <button class="choice-btn" onclick="lookAround()">Look around to see if the coast is clear</button>
                </div>
                <div class="choices-container" id="scene4-extra" style="display:none;"></div>
            </div>
        </div>
        
        <!-- Scene 5 -->
        <div id="scene5" class="scene">
            <div class="artwork-container">
                <img src="GOBLIN.jpg" alt="Attacked by goblins" class="artwork">
            </div>
            <div class="textbox">
                <div class="inventory-status" id="inventory5"></div>
                As you step inside a shriek pierces the darkness. Goblins leap from the shadows brandishing crude weapons. There is no time to think only to fight.
                <div class="choices-container">
                    <button class="choice-btn" onclick="showScene(6)">FIGHT</button>
                </div>
            </div>
        </div>
        
        <!-- Scene 6 - Victory Over Goblins -->
        <div id="scene6" class="scene">
            <div class="artwork-container">
                <img src="GOBLIN.jpg" alt="Victory over goblins" class="artwork">
            </div>
            <div class="textbox">
                <div class="inventory-status" id="inventory6"></div>
                With a swift and decisive strike, you deliver a fatal blow to one of the goblins. The other, seeing its companion fall, turns and flees into the darkness. You have successfully survived the encounter and proven your combat prowess.
                <div class="choices-container">
                    <button class="choice-btn" onclick="showScene(7)">Explore the cave further</button>
                </div>
            </div>
        </div>
        
        <!-- Scene 7 - Treasure Chest -->
        <div id="scene7" class="scene">
            <div class="artwork-container">
                <img src="GOBLINATTACK.jpg" alt="Treasure chest of gold" class="artwork">
            </div>
            <div class="textbox">
                <div class="inventory-status" id="inventory7"></div>
                Venturing deeper into the cave, you discover a hidden chamber. In the flickering light, you spot a magnificent chest overflowing with gold coins and precious gems. The stranger's lost item was indeed valuable - this treasure could change your fortune forever.
                <div class="choices-container">
                    <button class="choice-btn" onclick="restartStory()">Claim the treasure and return to the stranger</button>
                </div>
            </div>
        </div>

        <!-- Scene 8 - Avoided Stranger, Found Cave -->
        <div id="scene8" class="scene">
            <div class="artwork-container">
                <img src="CAVE.jpg" alt="Cave door without key" class="artwork">
            </div>
            <div class="textbox">
                <div class="inventory-status" id="inventory8"></div>
                You continue down the path, avoiding the strange man with the spear. Eventually, you come across a cave with a heavy wooden door. You try to push it open, but it's firmly locked. Without a key, there's no way to enter. Perhaps you should have talked to that stranger after all...
                <div class="choices-container">
                    <button class="choice-btn" onclick="showScene(1)">Go back and reconsider talking to the stranger</button>
                    <button class="choice-btn" onclick="showScene(9)">Keep exploring the area around the cave</button>
                </div>
            </div>
        </div>

        <!-- Scene 9 - Exploring Around Cave -->
        <div id="scene9" class="scene">
            <div class="artwork-container">
                <img src="CAVE.jpg" alt="Exploring around the cave" class="artwork">
            </div>
            <div class="textbox">
                <div class="inventory-status" id="inventory9"></div>
                You search around the cave entrance, looking for another way in or perhaps a hidden key. After thoroughly examining every rock and crevice, you find nothing. The door remains stubbornly locked, and your curiosity about what lies within only grows stronger.
                <div class="choices-container">
                    <button class="choice-btn" onclick="showScene(1)">Return to find the stranger with the spear</button>
                    <button class="choice-btn" onclick="restartStory()">Give up and start your journey over</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API base URL - will work both locally and when deployed
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:3000' 
            : 'https://the-mysterious-stranger.vercel.app';
            
        // Game state variables
        let hasKey = false;
        let acceptedQuest = false;
        
        // Security: Input validation
        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            return input.trim().replace(/[<>]/g, '');
        }
        
        // Security: Validate wallet address format
        function isValidWalletAddress(address) {
            if (!address || typeof address !== 'string') return false;
            return /^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(address.trim());
        }
        
        // Security: Proper session encryption using Web Crypto API
        let sessionEncryptionKey = null;
        
        async function initializeEncryption() {
            try {
                // Generate or retrieve encryption key
                const keyData = sessionStorage.getItem('session_key');
                if (keyData) {
                    const keyBuffer = Uint8Array.from(JSON.parse(keyData));
                    sessionEncryptionKey = await crypto.subtle.importKey(
                        'raw', keyBuffer, 'AES-GCM', false, ['encrypt', 'decrypt']
                    );
                } else {
                    // Generate new key
                    sessionEncryptionKey = await crypto.subtle.generateKey(
                        { name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']
                    );
                    const exported = await crypto.subtle.exportKey('raw', sessionEncryptionKey);
                    sessionStorage.setItem('session_key', JSON.stringify(Array.from(exported)));
                }
            } catch (error) {
                console.error('Failed to initialize encryption:', error);
                // Fallback to base64 (less secure but functional)
                sessionEncryptionKey = null;
            }
        }
        
        async function secureStore(key, value) {
            try {
                if (sessionEncryptionKey) {
                    // Use proper encryption
                    const iv = crypto.getRandomValues(new Uint8Array(12));
                    const encoded = new TextEncoder().encode(JSON.stringify(value));
                    const encrypted = await crypto.subtle.encrypt(
                        { name: 'AES-GCM', iv }, sessionEncryptionKey, encoded
                    );
                    const combined = new Uint8Array(iv.length + encrypted.byteLength);
                    combined.set(iv);
                    combined.set(new Uint8Array(encrypted), iv.length);
                    sessionStorage.setItem(key, btoa(String.fromCharCode(...combined)));
                } else {
                    // Fallback to base64 encoding
                    const encoded = btoa(JSON.stringify(value));
                    sessionStorage.setItem(key, encoded);
                }
            } catch (error) {
                console.error('Failed to store session:', error);
            }
        }
        
        async function secureRetrieve(key) {
            try {
                const stored = sessionStorage.getItem(key);
                if (!stored) return null;
                
                if (sessionEncryptionKey) {
                    // Decrypt properly encrypted data
                    const combined = new Uint8Array(atob(stored).split('').map(c => c.charCodeAt(0)));
                    const iv = combined.slice(0, 12);
                    const encrypted = combined.slice(12);
                    const decrypted = await crypto.subtle.decrypt(
                        { name: 'AES-GCM', iv }, sessionEncryptionKey, encrypted
                    );
                    return JSON.parse(new TextDecoder().decode(decrypted));
                } else {
                    // Fallback to base64 decoding
                    return JSON.parse(atob(stored));
                }
            } catch (error) {
                console.error('Failed to retrieve session:', error);
                return null;
            }
        }
        
        // Simple base58 encoding function
        function base58Encode(bytes) {
            const alphabet = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
            let num = 0n;
            for (let i = 0; i < bytes.length; i++) {
                num = num * 256n + BigInt(bytes[i]);
            }
            let str = '';
            while (num > 0n) {
                str = alphabet[Number(num % 58n)] + str;
                num = num / 58n;
            }
            // Handle leading zeros
            for (let i = 0; i < bytes.length && bytes[i] === 0; i++) {
                str = '1' + str;
            }
            return str;
        }
            
        // Security: Request timestamp for anti-replay protection
        function addTimestamp(body) {
            return {
                timestamp: Date.now().toString()
            };
        }
        
        // Security: Make timestamped API request
        async function makeTimestampedRequest(url, body) {
            const timestamp = Date.now().toString();
            
            return fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Request-Timestamp': timestamp
                },
                body: JSON.stringify(body)
            });
        }
        
        let isVerified = false;
        let sessionToken = null;
        let walletProvider = null;
        let connectedWallet = null;

        // Update inventory display
        function updateInventory() {
            const inventoryElements = document.querySelectorAll('[id^="inventory"]');
            inventoryElements.forEach(el => {
                if (hasKey) {
                    el.textContent = "ðŸ—ï¸ Ornate Key";
                } else {
                    el.textContent = "";
                }
            });
        }

        // Accept quest and receive key
        function acceptQuest() {
            acceptedQuest = true;
            hasKey = true;
            updateInventory();
            showScene(4);
        }

        // Check if user has a valid session on page load
        async function checkExistingSession() {
            const sessionData = await secureRetrieve('nft_session_token');
            if (!sessionData || !sessionData.token) return false;
            
            const token = sessionData.token;

            try {
                const response = await fetch(`${API_BASE_URL}/api/verify-nft`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.valid) {
                        isVerified = true;
                        sessionToken = token;
                        connectedWallet = data.walletAddress;
                        updateWalletStatus(`Connected: ${data.walletAddress.substring(0, 8)}...`, true);
                        showScene(0);
                        return true;
                    }
                }
            } catch (error) {
                console.error('Session check failed:', error);
            }

            localStorage.removeItem('nft_session_token');
            return false;
        }

        // Update wallet connection status display
        function updateWalletStatus(message, connected = false) {
            const statusDiv = document.getElementById('walletStatus');
            statusDiv.textContent = message;
            statusDiv.className = `wallet-status ${connected ? 'wallet-connected' : 'wallet-disconnected'}`;
        }

        // Enhanced wallet detection function
        function detectWallet() {
            console.log('Detecting wallets...');
            console.log('Available window objects:', Object.keys(window).filter(key => 
                key.toLowerCase().includes('solana') || 
                key.toLowerCase().includes('phantom') || 
                key.toLowerCase().includes('solflare') || 
                key.toLowerCase().includes('backpack') ||
                key.toLowerCase().includes('ethereum')
            ));
            
            // iOS Mobile Wallet Detection (check first)
            if (window.solflare && typeof window.solflare.connect === 'function') {
                console.log('Solflare mobile wallet detected via window.solflare');
                return { provider: window.solflare, type: 'Solflare Mobile' };
            }
            
            if (window.backpack && typeof window.backpack.connect === 'function') {
                console.log('Backpack mobile wallet detected via window.backpack');
                return { provider: window.backpack, type: 'Backpack Mobile' };
            }
            
            if (window.phantom && typeof window.phantom.connect === 'function') {
                console.log('Phantom mobile wallet detected via window.phantom');
                return { provider: window.phantom, type: 'Phantom Mobile' };
            }
            
            // iOS Web3 Provider Detection
            if (window.ethereum) {
                console.log('Ethereum provider detected, checking for Solana wallets...');
                if (window.ethereum.isSolflare) {
                    console.log('Solflare mobile wallet detected via ethereum provider');
                    return { provider: window.ethereum, type: 'Solflare Mobile (Ethereum)' };
                } else if (window.ethereum.isBackpack) {
                    console.log('Backpack mobile wallet detected via ethereum provider');
                    return { provider: window.ethereum, type: 'Backpack Mobile (Ethereum)' };
                }
            }
            
            // Check for Phantom first (most common)
            if (window.solana && window.solana.isPhantom) {
                console.log('Phantom wallet detected');
                return { provider: window.solana, type: 'Phantom' };
            }
            
            // Check for Backpack - multiple detection methods
            if (window.backpack && window.backpack.solana) {
                console.log('Backpack wallet detected via window.backpack.solana');
                return { provider: window.backpack.solana, type: 'Backpack' };
            }
            
            if (window.backpack) {
                console.log('Backpack wallet detected via window.backpack');
                return { provider: window.backpack, type: 'Backpack' };
            }
            
            if (window.solana && window.solana.isBackpack) {
                console.log('Backpack wallet detected via window.solana.isBackpack');
                return { provider: window.solana, type: 'Backpack' };
            }
            
            // Check for Solflare - try multiple detection methods
            if (window.solflare && window.solflare.solana) {
                console.log('Solflare wallet detected via window.solflare.solana');
                return { provider: window.solflare.solana, type: 'Solflare' };
            }
            
            if (window.solflare) {
                console.log('Solflare wallet detected via window.solflare');
                return { provider: window.solflare, type: 'Solflare' };
            }
            
            if (window.solana && window.solana.isSolflare) {
                console.log('Solflare wallet detected via window.solana.isSolflare');
                return { provider: window.solana, type: 'Solflare' };
            }
            
            // Check for other wallets
            if (window.solana && window.solana.isSlope) {
                console.log('Slope wallet detected');
                return { provider: window.solana, type: 'Slope' };
            }
            
            if (window.solana && window.solana.isGlow) {
                console.log('Glow wallet detected');
                return { provider: window.solana, type: 'Glow' };
            }
            
            // Generic Solana wallet (fallback)
            if (window.solana && typeof window.solana.connect === 'function') {
                console.log('Generic Solana wallet detected');
                return { provider: window.solana, type: 'Solana' };
            }
            
            // Generic fallback - look for any object with connect method
            for (const key of Object.keys(window)) {
                const obj = window[key];
                if (obj && typeof obj === 'object' && typeof obj.connect === 'function') {
                    console.log(`Generic wallet detected via window.${key}`);
                    return { provider: obj, type: `Generic (${key})` };
                }
            }
            
            console.log('No wallet detected');
            return null;
        }

        // Enhanced signing function for different wallets
        async function signMessageWithWallet(walletInfo, message) {
            const { provider, type } = walletInfo;
            const encodedMessage = new TextEncoder().encode(message);
            
            console.log(`[${type}] Attempting to sign message...`);
            console.log(`[${type}] Provider object:`, provider);
            console.log(`[${type}] Available methods:`, Object.getOwnPropertyNames(provider));
            
            try {
                let signature;
                
                switch (type) {
                    case 'Phantom':
                        // Phantom uses standard signMessage
                        if (typeof provider.signMessage === 'function') {
                            const result = await provider.signMessage(encodedMessage, 'utf8');
                            signature = result.signature;
                        } else {
                            throw new Error('Phantom wallet does not support message signing');
                        }
                        break;
                        
                    case 'Backpack':
                        // Backpack specific signing logic
                        if (typeof provider.signMessage === 'function') {
                            try {
                                console.log(`[${type}] Trying standard signMessage with utf8...`);
                                const result = await provider.signMessage(encodedMessage, 'utf8');
                                signature = result.signature;
                            } catch (error) {
                                console.log(`[${type}] UTF8 method failed, trying without encoding...`, error);
                                try {
                                    const result = await provider.signMessage(encodedMessage);
                                    signature = result.signature;
                                } catch (error2) {
                                    console.log(`[${type}] Standard methods failed, trying alternative...`, error2);
                                    // Some Backpack versions might use different method signatures
                                    const result = await provider.signMessage(message);
                                    signature = result.signature;
                                }
                            }
                        } else if (typeof provider.sign === 'function') {
                            console.log(`[${type}] Using provider.sign method...`);
                            const result = await provider.sign(encodedMessage);
                            signature = result.signature;
                        } else {
                            throw new Error('Backpack wallet does not support message signing');
                        }
                        break;
                        
                    case 'Solflare':
                        // Solflare has different signing methods
                        if (typeof provider.signMessage === 'function') {
                            try {
                                // Try the standard method first
                                const result = await provider.signMessage(encodedMessage, 'utf8');
                                signature = result.signature;
                            } catch (error) {
                                console.log(`[${type}] Standard signMessage failed, trying alternative...`);
                                // Try alternative method
                                const result = await provider.signMessage(encodedMessage);
                                signature = result.signature;
                            }
                        } else if (typeof provider.sign === 'function') {
                            const result = await provider.sign(encodedMessage);
                            signature = result.signature;
                        } else {
                            throw new Error('Solflare wallet does not support message signing');
                        }
                        break;
                        
                    case 'Slope':
                    case 'Glow':
                    case 'Solana':
                    default:
                        // Generic signing approach
                        if (typeof provider.signMessage === 'function') {
                            try {
                                const result = await provider.signMessage(encodedMessage, 'utf8');
                                signature = result.signature;
                            } catch (error) {
                                console.log(`[${type}] UTF8 encoding failed, trying without...`);
                                const result = await provider.signMessage(encodedMessage);
                                signature = result.signature;
                            }
                        } else if (typeof provider.sign === 'function') {
                            const result = await provider.sign(encodedMessage);
                            signature = result.signature;
                        } else {
                            throw new Error(`${type} wallet does not support message signing`);
                        }
                        break;
                }
                
                console.log(`[${type}] Signing successful:`, signature);
                
                // Convert signature to base58 if it's a Uint8Array
                if (signature instanceof Uint8Array) {
                    return base58Encode(signature);
                } else if (typeof signature === 'string') {
                    return signature;
                } else {
                    throw new Error(`Unsupported signature format from ${type}`);
                }
                
            } catch (error) {
                console.error(`[${type}] Signing failed:`, error);
                throw new Error(`Failed to sign message with ${type}: ${error.message}`);
            }
        }

        // Connect to Solana wallet
        async function connectWallet() {
            const connectBtn = document.getElementById('connectBtn');
            const messageDiv = document.getElementById('verificationMessage');
            
            connectBtn.disabled = true;
            connectBtn.textContent = 'Connecting...';
            messageDiv.innerHTML = '<div class="loading">Looking for wallet...</div>';

            try {
                // Detect wallet
                const walletInfo = detectWallet();
                
                if (!walletInfo) {
                    console.log('No wallet provider found.');
                    messageDiv.innerHTML = '<div class="error">No Solana wallet detected. Please install a supported wallet like <a href="https://phantom.app/" target="_blank">Phantom</a>, <a href="https://solflare.com/" target="_blank">Solflare</a>, or <a href="https://backpack.app/" target="_blank">Backpack</a>.</div>';
                    connectBtn.disabled = false;
                    connectBtn.textContent = 'Connect Wallet';
                    return;
                }

                const { provider, type } = walletInfo;
                console.log(`Found ${type} wallet`);

                // Connect to wallet with wallet-specific handling
                let response;
                try {
                    console.log(`[${type}] Attempting to connect...`);
                    console.log(`[${type}] Available methods:`, Object.getOwnPropertyNames(provider));
                    
                    // iOS Mobile wallet specific handling
                    if (type.includes('Mobile')) {
                        console.log(`[${type}] Using mobile wallet connection...`);
                        
                        // Add a small delay for mobile wallets to initialize
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        // Mobile wallets often have different connection methods
                        if (typeof provider.connect === 'function') {
                            console.log(`[${type}] Using connect() method`);
                            try {
                                response = await provider.connect();
                            } catch (error) {
                                console.log(`[${type}] Connect() failed, trying request()...`);
                                if (typeof provider.request === 'function') {
                                    response = await provider.request({ method: 'connect' });
                                } else {
                                    throw error;
                                }
                            }
                        } else if (typeof provider.request === 'function') {
                            // Some mobile wallets use request method
                            console.log(`[${type}] Using request() method`);
                            response = await provider.request({ method: 'connect' });
                        } else if (typeof provider.enable === 'function') {
                            // Some use enable method
                            console.log(`[${type}] Using enable() method`);
                            response = await provider.enable();
                        } else if (typeof provider.getAccounts === 'function') {
                            // Some mobile wallets use getAccounts
                            console.log(`[${type}] Using getAccounts() method`);
                            response = await provider.getAccounts();
                        } else {
                            console.error(`[${type}] No supported connection method found`);
                            throw new Error('Mobile wallet does not support connection');
                        }
                    } else {
                        // Desktop wallet connection
                        console.log(`[${type}] Using desktop wallet connection`);
                        response = await provider.connect();
                    }
                    
                    console.log(`[${type}] Connection response:`, response);
                    console.log(`[${type}] Response type:`, typeof response);
                    console.log(`[${type}] Response keys:`, response ? Object.keys(response) : 'null');
                } catch (connectError) {
                    console.error(`[${type}] Wallet connection failed:`, connectError);
                    
                    // For mobile wallets, try alternative connection methods
                    if (type.includes('Mobile') && (connectError.message.includes('Plugin Closed') || connectError.message.includes('Failed to connect'))) {
                        console.log(`[${type}] Plugin closed error detected, trying alternative methods...`);
                        
                        // Wait a bit longer before retry
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        try {
                            // Try different connection approaches for mobile
                            if (typeof provider.request === 'function') {
                                console.log(`[${type}] Trying request method with different parameters...`);
                                response = await provider.request({ 
                                    method: 'connect',
                                    params: []
                                });
                            } else if (typeof provider.enable === 'function') {
                                console.log(`[${type}] Trying enable method...`);
                                response = await provider.enable();
                            } else if (typeof provider.getAccounts === 'function') {
                                console.log(`[${type}] Trying getAccounts method...`);
                                response = await provider.getAccounts();
                            } else {
                                throw new Error('No alternative connection methods available');
                            }
                            
                            console.log(`[${type}] Alternative connection successful:`, response);
                        } catch (altError) {
                            console.error(`[${type}] Alternative connection methods also failed:`, altError);
                            throw new Error(`Failed to connect to ${type}. Please ensure the wallet app is open and try again.`);
                        }
                    } else {
                        throw new Error(`Failed to connect to ${type}. Please try again.`);
                    }
                }
                
                // Extract wallet address from response
                let rawWalletAddress;
                if (response.publicKey) {
                    rawWalletAddress = response.publicKey.toString();
                } else if (response.pubkey) {
                    rawWalletAddress = response.pubkey.toString();
                } else if (response.address) {
                    rawWalletAddress = response.address;
                } else if (response.account) {
                    rawWalletAddress = response.account;
                } else if (response.accounts && response.accounts[0]) {
                    rawWalletAddress = response.accounts[0];
                } else if (typeof response === 'string') {
                    rawWalletAddress = response;
                } else {
                    console.error('Unexpected wallet response format:', response);
                    throw new Error(`Unexpected response format from ${type}`);
                }
                
                // Validate wallet address
                if (!isValidWalletAddress(rawWalletAddress)) {
                    throw new Error('Invalid wallet address received from provider');
                }
                
                connectedWallet = sanitizeInput(rawWalletAddress);
                
                updateWalletStatus(`Connected: ${connectedWallet.substring(0, 8)}... (${type})`, true);
                messageDiv.innerHTML = '<div class="loading">Wallet connected. Generating challenge...</div>';

                // Step 1: Get challenge from server
                const challengeResponse = await makeTimestampedRequest(`${API_BASE_URL}/api/verify-nft`, {
                    action: 'challenge',
                    walletAddress: connectedWallet
                });

                const challengeData = await challengeResponse.json();
                if (!challengeData.success) {
                    throw new Error(challengeData.error);
                }

                messageDiv.innerHTML = '<div class="loading">Please sign the message in your wallet to verify ownership...</div>';

                // Step 2: Sign the challenge message
                const signature = await signMessageWithWallet(walletInfo, challengeData.message);

                messageDiv.innerHTML = '<div class="loading">Verifying signature and checking NFT ownership...</div>';

                // Step 3: Verify signature and check NFT
                const verifyResponse = await makeTimestampedRequest(`${API_BASE_URL}/api/verify-nft`, {
                    action: 'verify',
                    walletAddress: connectedWallet,
                    signature: signature,
                    challenge: challengeData.challenge
                });

                const verifyData = await verifyResponse.json();

                if (verifyData.success) {
                    isVerified = true;
                    sessionToken = verifyData.sessionToken;
                    
                    // Store session securely
                    await secureStore('nft_session_token', {
                        token: sessionToken,
                        wallet: connectedWallet.substring(0, 8) + '...',
                        walletType: type,
                        timestamp: Date.now()
                    });
                    
                    messageDiv.innerHTML = '<div class="success">Wallet verified and NFT ownership confirmed! Welcome, adventurer.</div>';
                    
                    setTimeout(() => {
                        showScene(0);
                    }, 2000);
                } else {
                    messageDiv.innerHTML = `<div class="error">Verification failed: ${verifyData.error}</div>`;
                    updateWalletStatus('Wallet connected but verification failed', false);
                    connectBtn.disabled = false;
                    connectBtn.textContent = 'Try Again';
                }

            } catch (error) {
                console.error('Wallet connection error:', error);
                if (error.message.includes('User rejected') || error.message.includes('cancelled')) {
                    messageDiv.innerHTML = '<div class="error">Wallet connection cancelled by user.</div>';
                } else {
                    messageDiv.innerHTML = `<div class="error">Connection failed: ${error.message}</div>`;
                }
                updateWalletStatus('Connection failed', false);
                connectBtn.disabled = false;
                connectBtn.textContent = 'Connect Wallet';
            }
        }

        // Verify session before accessing any scene
        async function verifySession() {
            const sessionData = await secureRetrieve('nft_session_token');
            if (!sessionData || !sessionData.token) return false;
            
            const token = sessionData.token;

            try {
                const response = await fetch(`${API_BASE_URL}/api/verify-nft`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.valid;
                }
            } catch (error) {
                console.error('Session verification failed:', error);
            }

            return false;
        }

        async function showScene(num) {
            // Always verify session before showing scenes (except verification page)
            if (num !== 'verification') {
                const sessionValid = await verifySession();
                if (!sessionValid) {
                    isVerified = false;
                    sessionToken = null;
                    connectedWallet = null;
                    sessionStorage.removeItem('nft_session_token');
                    updateWalletStatus('Session expired', false);
                    document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
                    document.getElementById('verification').classList.add('active');
                    return;
                }
            }

            document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
            
            if (num === 'verification') {
                document.getElementById('verification').classList.add('active');
            } else {
                document.getElementById('scene'+num).classList.add('active');
            }
            
            // Update inventory display whenever scene changes
            updateInventory();
            
            // Reset scene 4 state every time you enter it (but preserve key status)
            if (num === 4) {
                if (hasKey) {
                    document.getElementById('scene4-text').innerText =
                        "You arrive at the mouth of the cave. The heavy wooden door stands before you, and you remember the ornate key the stranger gave you. The air is thick with anticipation.";
                    document.getElementById('scene4-choices').style.display = '';
                    document.getElementById('scene4-choices').innerHTML = `
                        <button class="choice-btn" onclick="enterCave()">Use the key and go in</button>
                        <button class="choice-btn" onclick="lookAround()">Look around to see if the coast is clear</button>
                    `;
                } else {
                    // This shouldn't happen if logic is correct, but just in case
                    document.getElementById('scene4-text').innerText =
                        "You arrive at the mouth of the cave. The heavy wooden door is locked tight. Without a key, you cannot enter.";
                    document.getElementById('scene4-choices').style.display = '';
                    document.getElementById('scene4-choices').innerHTML = `
                        <button class="choice-btn" onclick="showScene(1)">Go back to find the stranger</button>
                    `;
                }
                document.getElementById('scene4-extra').style.display = 'none';
                document.getElementById('scene4-extra').innerHTML = '';
            }
        }

        function restartStory() {
            // Reset game state
            hasKey = false;
            acceptedQuest = false;
            updateInventory();
            showScene(0);
        }

        // Scene 4 logic - only works if player has key
        function enterCave() {
            if (hasKey) {
                showScene(5);
            } else {
                // This shouldn't happen, but just in case
                alert("You need a key to enter the cave!");
            }
        }

        function lookAround() {
            if (!hasKey) {
                // This shouldn't happen in normal gameplay
                return;
            }
            
            const extra = document.getElementById('scene4-extra');
            extra.innerHTML = '';
            if (Math.floor(Math.random()*6) === 0) {
                document.getElementById('scene4-text').innerText =
                    "You listen closely and use your key to quietly unlock the door. Suddenly you hear shuffling and guttural whispers on the other side. Before you can react, the door bursts open from the inside!";
                document.getElementById('scene4-choices').style.display = 'none';
                extra.style.display = '';
                extra.innerHTML = `<button class='choice-btn' onclick='showScene(5)'>Stand your ground and fight</button> <button class='choice-btn' onclick='showScene(1)'>This is too scary, run back to the stranger</button>`;
            } else {
                document.getElementById('scene4-text').innerText =
                    "You look around carefully and listen at the door. All seems quiet. You use your ornate key to unlock the door. Gathering your courage, you decide to go in.";
                document.getElementById('scene4-choices').style.display = 'none';
                extra.style.display = '';
                extra.innerHTML = `<button class='choice-btn' onclick='showScene(5)'>Enter the cave quietly</button>`;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeEncryption();
            updateInventory(); // Initialize inventory display
            checkExistingSession();
        });
    </script>
</body>
</html>
